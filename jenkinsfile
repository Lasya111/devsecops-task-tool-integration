pipeline {
 Â Â  agent {
 Â Â Â Â Â Â  label 'lasya-security-agent'
 Â Â  }



 Â Â  environment {
 Â Â Â Â Â Â  VAULT_ADDR = 'http://34.228.140.38:8400/'
 Â Â Â Â Â Â  DOCKERHUB_USER = 'lasyacloudlab'
 Â Â Â Â Â Â  IMAGE_NAME = 'jenkins-docker-lab'
 Â Â Â Â Â Â  SONARQUBE = 'SonarCloud'
 Â Â Â Â Â Â  SONAR_TOKEN = credentials('sonarcloud-token-lasya')
 Â Â  }



 Â Â  stages {
 Â Â Â Â Â Â  stage('Cleanup') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  cleanWs()
 Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  stage('Checkout') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  checkout scm
 Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  stage('GitLeaks Scan') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sh '''#!/bin/bash
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  set -eux
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  # Install gitleaks if not present
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if ! command -v gitleaks &> /dev/null; then
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  echo "Installing Gitleaks..."
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  wget https://github.com/zricethezav/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  chmod +x gitleaks
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sudo mv gitleaks /usr/local/bin/
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  fi
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  # Run gitleaks detect even if from non commited codes





 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  echo "ğŸ” Running Gitleaks scan..."
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  set +eÂ  # temporarily disable fail-fast
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  gitleaks detect --source python_app --no-git --verbose --report-path gitleaks-report.json 
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  result=$?Â  # capture exit status
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  set -eÂ  # re-enable fail-fast



 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if [ "$result" -ne 0 ]; then
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  echo "âŒ Gitleaks found leaks (exit code $result)"
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  exit 1
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  else
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  echo "âœ… No leaks found."
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  fi
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  '''
 Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  stage('Fetch Secret from Vault') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  script {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  withVault([vaultSecrets: [
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [path: 'secret/app_secret', secretValues: [[envVar: 'APP1', vaultKey: 'app1']
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ]]
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ]]) {



 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sh '''
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  docker rm -f py-app || true
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  docker rmi -f flask-vault-app:latest || true
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  docker build -t flask-vault-app:latest .
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  docker run -d -p 8005:5000 -e API_KEY=$APP1 --name py-app flask-vault-app:latest
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  '''
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  stage('SonarQube Analysis') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  withSonarQubeEnv(credentialsId: 'sonarcloud-token-lasya', installationName: 'lasya-sq') {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sh '''#!/bin/bash
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  set -eux
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  echo "=== SonarQube installation ==="
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  export SONAR_SCANNER_VERSION=7.2.0.5079
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux-x64
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VEâ€¦
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  export PATH=$SONAR_SCANNER_HOME/bin:$PATH



 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  echo "=== Running SonarQube Scanner ==="
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sonar-scanner \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  -Dsonar.organization="lasya111" \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  -Dsonar.projectKey="Lasya111_devsecops1" \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  -Dsonar.host.url=https://sonarcloud.io \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  -Dsonar.sources=. \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  -Dsonar.python.coverage.reportPaths=coverage.xml \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  -Dsonar.c.file.suffixes=- \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  -Dsonar.cpp.file.suffixes=- \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  -Dsonar.objc.file.suffixes=- \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  -Dsonar.login=$SONAR_TOKEN \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  -Dsonar.exclusions=**/venv/**,**/__pycache__/**,**/tests/** \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  '''
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  stage('Quality Gate') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  timeout(time: 2, unit: 'MINUTES') {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  waitForQualityGate abortPipeline: true
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  stage('Python Setup & Test with Coverage') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  dir('python_app') {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sh '''#!/bin/bash
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  set -euxo pipefail
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  rm -rf venv
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  python3 -m venv venv
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ./venv/bin/pip install --upgrade pip
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ./venv/bin/pip install -r requirements.txt
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ./venv/bin/python -m pytest tests/ --maxfail=1 --disable-warnings -q \
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  --cov=. --cov-report=xml:../coverage.xml
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  '''Â Â Â Â Â Â Â Â Â Â Â Â Â Â  
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  stage('Clean up image and container') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  script {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // sh 'git clone git@github.com:Vishwanathms/t7.14-py-jenkins.git'
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sh 'docker rmÂ  jenkins_app -f || true'
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sh 'docker image rmi $DOCKERHUB_USER/$IMAGE_NAME:latest || true'
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â Â Â Â Â  }Â  
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  stage('Build Docker Image') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  script {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sh 'docker build -t $DOCKERHUB_USER/$IMAGE_NAME:latest Python-app'
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  stage('Scan Docker Image with Trivy') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Scan and save report
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sh '''
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  mkdir -p trivy-reports
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  trivy image --no-progress --exit-code 0 --format table -o trivy-reports/report.txt $DOCKERHUB_USER/$IMAGE_NAME
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  cat trivy-reports/report.txt
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  '''
 Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  stage('Archive Trivy Report') {
 Â Â Â Â Â Â Â Â Â Â  steps {
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â  archiveArtifacts artifacts: 'trivy-reports/report.txt', fingerprint: true
 Â Â Â Â Â Â Â Â Â Â  }
 Â Â Â Â Â Â  }
 Â Â  
 Â Â  }



 Â Â  post {
 Â Â Â Â Â Â  success {
 Â Â Â Â Â Â Â Â Â Â  echo 'Pipeline completed successfully!'
 Â Â Â Â Â Â  }
 Â Â Â Â Â Â  failure {
 Â Â Â Â Â Â Â Â Â Â  echo 'Pipeline failed.'
 Â Â Â Â Â Â  }
 Â Â  }
}